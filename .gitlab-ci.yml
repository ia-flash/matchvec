# This file is a template, and might need editing before it works on your project.
# To contribute improvements to CI/CD templates, please follow the Development guide at:
# https://docs.gitlab.com/ee/development/cicd/templates.html
# This specific template is located at:
# https://gitlab.com/gitlab-org/gitlab/-/blob/master/lib/gitlab/ci/templates/Python.gitlab-ci.yml

# Official language image. Look for the different tagged releases at:
# https://hub.docker.com/r/library/python/tags/
#image: python:latest

# Change pip's cache directory to be inside the project directory since we can
# only cache local items.
variables:
  PIP_CACHE_DIR: "/cache/$CI_PROJECT_NAME/.cache/pip"
  XDG_CACHE_HOME: "/cache/$CI_PROJECT_NAME/.cache"


# Pip's cache doesn't store the python packages
# https://pip.pypa.io/en/stable/reference/pip_install/#caching
#
# If you want to also cache the installed packages, you have to install
# them in a virtualenv and cache it as well.


build_wheel:
  stage: build
  script:
    - python3 -m venv venv
    - source venv/bin/activate
    - pip3 install -U pip
    - pip3 install wheel
    - python3 setup.py bdist_wheel
  artifacts:
    paths:
      - dist/*.whl
    expire_in: 1 week
  tags:
    - python3
    - docker
  only:
    - tags


upload_wheel:
  stage: deploy
  script:
    - python3 -m venv venv
    - source venv/bin/activate
    - pip3 install -U pip
    - pip3 install twine
    - echo Upload wheel
    - TWINE_PASSWORD=${CI_JOB_TOKEN} TWINE_USERNAME=gitlab-ci-token python -m twine upload --repository-url ${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/pypi dist/*
  tags:
    - python3
    - docker
  only:
    - tags

staging:
  stage: deploy
  variables:
    PIP_CACHE_DIR: "/home/www/.cache/pip"
    GIT_STRATEGY: none
    VERSION_TAG: $CI_COMMIT_TAG
    MODEL_VERSION: "1.0"
  script:
    - if [ -z $DETECTION_MODEL ]; then echo "DETECTION_MODEL not set"; exit 1; fi
    - if [ -z $DETECTION_THRESHOLD ]; then echo "DETECTION_THRESHOLD not set"; exit 1; fi
    - if [ -z $CLASSIFICATION_MODEL ]; then echo "CLASSIFICATION_MODEL not set"; exit 1; fi
    - if [ -z $BACKEND ]; then echo "BACKEND not set"; exit 1; fi
    - if [ -z $INSTALL_DIR ]; then echo "INSTALL_DIR not set"; exit 1; fi
    #- if [ -z $APP_PORT ]; then echo "APP_PORT not set"; exit 1; fi
    - ipath=${INSTALL_DIR}/${VERSION_TAG}
    - echo Installation dans $ipath
    - rm -rf $ipath
    - python3 -m venv $ipath
    - source $ipath/bin/activate
    - pip3 install -U pip
    - pip3 install dist/${CI_PROJECT_NAME}*.whl
    - mkdir -p $ipath/models/${DETECTION_MODEL}
    - mkdir -p $ipath/models/${CLASSIFICATION_MODEL}
    - yolo_weights="${YOLO_WEIGHTS:-yolov3.weights}"
    - yolo_cfg="${YOLO_CFG:-yolov3.cfg}"
    - 'curl --insecure --header "JOB-TOKEN: ${CI_JOB_TOKEN}" ${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/object_detection/${MODEL_VERSION}/${yolo_weights} -o $ipath/models/${DETECTION_MODEL}/${yolo_weights}'
    - 'curl --insecure --header "JOB-TOKEN: ${CI_JOB_TOKEN}" ${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/object_detection/${MODEL_VERSION}/${yolo_cfg} -o $ipath/models/${DETECTION_MODEL}/${yolo_cfg}'
    - 'curl --insecure --header "JOB-TOKEN: ${CI_JOB_TOKEN}" ${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/object_detection/${MODEL_VERSION}/labels.json -o $ipath/models/${DETECTION_MODEL}/labels.json'
    - '[ $(curl --insecure --header "JOB-TOKEN: ${CI_JOB_TOKEN}" ${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/classification/${MODEL_VERSION}/classification_model.onnx -o $ipath/models/${CLASSIFICATION_MODEL}/classifcation_model_onnx1.5.onnx --write-out "%{http_code}" --silent) -eq 200 ] || (echo "Erreur telechargement fichier classification_model.onnx" && exit 1)'
    - 'curl --insecure --header "JOB-TOKEN: ${CI_JOB_TOKEN}" ${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/classification/${MODEL_VERSION}/idx_to_class.json -o $ipath/models/${CLASSIFICATION_MODEL}/idx_to_class.json'
    - echo -e "export BACKEND=${BACKEND}\nexport DETECTION_MODEL=${DETECTION_MODEL}\nexport DETECTION_THRESHOLD=0.8\nexport CLASSIFICATION_MODEL=${CLASSIFICATION_MODEL}\nexport BASE_MODEL_PATH=$ipath/models" > $ipath/setenv.sh
    - chmod +x $ipath/setenv.sh
    - rm -rf ${INSTALL_DIR}/current
    - ln -s $ipath ${INSTALL_DIR}/current
  tags:
    - python3
    - tscapx004r
  only:
    - tags
  when: manual
